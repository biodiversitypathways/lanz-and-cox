---
title: "Report on the use of passive acoustic monitoring for songbirds and seabirds on Lanz and Cox Islands"
format:
  html:
    grid:
      margin-width: 300px
navbar: right
theme: cosmo
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: 
  - name: "Alex MacPhail"
    affiliation: "Biodiversity Pathways Ltd."
  - name: "Kevin Kelly"
    affiliation: "Biodiversity Pathways Ltd."
  - name: "Eric McLaren"
    affiliation: "BC Ministry of Environment and Parks"
  - name: "Iain Reid"
    affiliation: "BC Ministry of Environment and Parks"
editor: visual
bibliography: references.bib
nocite: '@*'
toc: true
toc-depth: 3
toc-expand: true
prefer-html: true
toc-location: left
styles: styles.css
github: https://github.com/biodiversitypathways/lanz-and-cox
---

```{r}
#| label: Load packages and authenticate to WildTrax
#| include: false
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(wildrtrax)
library(tidyverse)
library(leaflet)

wt_auth()

load("lanz-and-cox.RData")
#save.image("lanz-and-cox.RData")

```

```{r}
#| include: false
#| echo: false
#| eval: false
#| warning: false
#| message: false

bcsi <- wt_download_report(4021, 'ARU', c('main','ai','recording'))

bcsi_main <- bcsi[[2]] |>
  mutate(year = year(recording_date_time))

lac_locs <- wt_get_sync("organization_locations", organization = 5853)

```

::: {.callout-note collapse="true" style="background-color: #f4f4f4; padding: 20px;"}
This report is dynamically generated, meaning its results may evolve with the addition of new data or further analyses. For the most recent updates, refer to the publication date and feel free to reach out to the authors.
:::

# Abstract

Passive acoustic monitoring was conducted on Lanz and Cox Islands to characterize seabird and songbird communities across multiple breeding seasons prior to invasive mink and raccoon eradication. Autonomous Recording Units (ARUs; SM4) were deployed at `r length(unique(bcsi$location))` locations and analyzed using a combination of machine-learning algorithms and expert validation. This report summarizes species presence, temporal patterns of detection, and relative abundance for seabirds and songbirds, and provides spatial representations of detections across both islands. These results establish a pre-eradication baseline to support evaluation of seabird prospecting activity and future changes in songbird communities following invasive predator removal.

# Land Acknowledgement

# Introduction

Lanz and Cox Islands support important seabird and songbird habitats, yet populations have been negatively affected by the presence of invasive predators, including mink and raccoon. As part of a broader restoration initiative, passive acoustic monitoring was implemented to document avian community composition prior to eradication activities. Autonomous recording units (ARUs) were deployed across both islands over three breeding seasons to capture vocal activity of seabirds and songbirds. Acoustic data were processed using the WildTrax data management platform in combination with BirdNET and HawkEars machine-learning algorithms, with detections verified using expert review informed by prior experience in marine acoustic environments. This report presents the results of these analyses, including species detected, timing of detections, relative abundance metrics, and spatial patterns of occurrence. Together, these data provide a baseline against which post-eradication monitoring can be compared to assess project outcomes and ecological recovery.

# Methods

## Data collection

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| include: true
#| fig-align: center
#| fig-cap: Locations from Lanz and Cox Provincial Park ARU Monitoring Program
#| label: fig-aru-monitoring-locations

leaflet() %>%
  addTiles() %>%
  addCircleMarkers(
    data = lac_locs,
    popup = ~paste("Location:", location, "<br>"),
    fillOpacity = 1,
    color = "black", 
    radius = 6 
  ) %>%
  addMeasure(primaryLengthUnit = "meters", primaryAreaUnit = "sqmeters") %>%
  addMiniMap(position = "bottomleft")

```

```{r}
#| echo: false
#| eval: false
#| warning: false
#| message: false
#| include: false

seabirds <- c(
  "Tufted Puffin",
  "Common Murre",
  "Cassin's Auklet",
  "Rhinoceros Auklet",
  "Short-tailed Albatross",
  "Black-footed Albatross",
  "Pink-footed Shearwater",
  "Marbled Murrelet",
  "Ancient Murrelet"
)

wt_get_species() |>
  filter(species_common_name %in% seabirds)

wt_get_project_species(4069) |>
  filter(species_common_name %in% seabirds)

bcsi_recs <- wt_get_sync("organization_recordings", organization = 5853)

```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| include: false

bcsi_recs |>
  mutate(date = as.Date(recording_date_time)) |>
  count(date) |>
  ggplot(aes(x=date, y=n)) +
  geom_bar(stat = "identity") +
  labs(
    x = "Date",
    y = "Number of recordings",
    title = "BCSI recording collection over time"
  ) +
  theme_minimal()

```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| include: true

noise_level_map <- c(
  "Low"     = 1,
  "Medium"  = 2,
  "High"    = 3,
  "Extreme" = 4
)

noise_pattern_map <- c(
  "Intermittent" = 2,
  "Infrequently"   = 1,
  "Frequent"     = 3,
  "Constant"     = 4
)

bcsi_noise <- bcsi[[3]] |>
  separate_rows(task_noise, sep = "\\+") |>
  separate(
    task_noise,
    into = c("noise_source", "noise_level", "noise_pattern"),
    sep = "/",
    fill = "right"
  ) |>
  select(task_id, noise_source, noise_level, noise_pattern) |>
  distinct() |>
  filter(noise_source == "Ocean") |>
  drop_na() |>
  mutate(
    noise_level_num   = unname(noise_level_map[noise_level]),
    noise_pattern_num = unname(noise_pattern_map[noise_pattern])
  ) 

bcsi_main_noise <- bcsi_main |>
  inner_join(bcsi_noise, by = "task_id")
  
bcsi_richness <- bcsi_main_noise %>%
  group_by(recording_id, noise_level, noise_level_num, noise_pattern_num) %>%
  summarise(
    richness = n_distinct(species_code[!is.na(species_code)]),
    .groups = "drop"
  ) |>
  mutate(noise_level = factor(
  noise_level,
  levels = c("Low", "Medium", "High", "Extreme"),
  ordered = TRUE
))

bcsi_individuals <- bcsi_main_noise %>%
  group_by(recording_id, noise_level, noise_level_num, noise_pattern_num, species_code) %>%
  summarise(individuals = max(individual_order),
    .groups = "drop"
  ) |>
  mutate(individuals = case_when(is.na(individuals) ~ 0, TRUE ~ individuals)) |>
  group_by(recording_id, noise_level, noise_level_num, noise_pattern_num) |>
  summarise(n = sum(individuals)) |>
  ungroup() |>
  mutate(
    noise_level = factor(
      noise_level,
      levels = c("Low", "Medium", "High", "Extreme"),
      ordered = TRUE
    )
  )

```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| include: true

ggplot(bcsi_richness, aes(factor(noise_level), richness)) +
  geom_boxplot() +
  labs(
    x = "Noise level (ordinal)",
    y = "Species richness per recording",
    title = "Species richness vs noise level"
  ) +
  theme_minimal()

ggplot(bcsi_individuals, aes(noise_level, n)) +
  geom_boxplot() +
  labs(
    x = "Noise level",
    y = "Individuals detected per recording",
    title = "Individuals detected vs noise level"
  ) +
  theme_minimal()

```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| include: true

bcsi_seabirds <- wt_download_report(4069, 'ARU', c('main','ai'))

eval <- wt_evaluate_classifier(bcsi_seabirds, resolution = "recording", remove_species = TRUE, species = "MAMU")
wt_additional_species(bcsi_seabirds, remove_species = TRUE, threshold = 0.8, resolution = "task")
```

## Data management, processing and quality control

All recordings were uploaded to WildTrax in order for the data to be accessible and stored. 

### Community data processing

For each sampling location and year, a total of nine autonomous recording unit (ARU) recordings, each 3 minutes in duration, were analyzed to characterize the songbird community. All vocalizing species were identified, and the abundance of each species was estimated using a count-removal framework based on time-to-first-detection, which helps reduce positive bias associated with repeated detections of the same individual within a recording. Recordings were intentionally distributed across diel periods to capture variation in vocal activity. Five recordings were selected during the dawn period (04:00–07:59), when songbird detectability is typically highest. Two recordings were selected during dusk (19:00–22:59), and two during the night (23:00–03:59), allowing for detection of crepuscular or nocturnally active species and providing a more complete representation of the avian community. This standardized temporal sampling design ensured consistent effort across locations and years while maximizing detectability across species with differing activity patterns.

### Evaluating performance of HawkEars on Common Murre and Marbled Murrelet



### Creating annotation datasets and new classifier implementation

## Results

## Discussion and recommendations
